{% extends 'scanner/base.html' %}
{% load static %}

{% block page_title %}Vulnerability Checkup: {{ checkup.target }}{% endblock %}

{% block extra_css %}
<style>
    .vuln-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    .vuln-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .vuln-card.critical {
        border-left-color: #dc3545;
    }
    .vuln-card.high {
        border-left-color: #fd7e14;
    }
    .vuln-card.medium {
        border-left-color: #ffc107;
    }
    .vuln-card.low {
        border-left-color: #28a745;
    }
    .severity-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 10px;
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 10px;
    }
    .vuln-details {
        display: none;
    }
    .vuln-card.expanded .vuln-details {
        display: block;
    }
    .vuln-card .toggle-icon {
        transition: transform 0.3s ease;
    }
    .vuln-card.expanded .toggle-icon {
        transform: rotate(180deg);
    }
    .checkup-info {
        background-color: rgba(138, 86, 255, 0.1);
        border-radius: 8px;
        padding: 15px;
    }
    .checkup-stat {
        text-align: center;
        padding: 10px;
        border-radius: 8px;
    }
    .checkup-stat .value {
        font-size: 1.8rem;
        font-weight: 700;
    }
    .checkup-stat .label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    .cve-link {
        color: var(--accent-color);
        text-decoration: none;
    }
    .cve-link:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Checkup Summary</h5>
                <div>
                    <a href="{% url 'scanner:vulnerability_dashboard' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="checkup-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Checkup Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>Target:</th>
                                    <td>{{ checkup.target.ip_address }} {% if checkup.target.hostname %}({{ checkup.target.hostname }}){% endif %}</td>
                                </tr>
                                <tr>
                                    <th>Scan Type:</th>
                                    <td>{{ checkup.scan_type|title }}</td>
                                </tr>
                                <tr>
                                    <th>Status:</th>
                                    <td>
                                        <span class="badge {% if checkup.status == 'completed' %}bg-success{% elif checkup.status == 'failed' %}bg-danger{% elif checkup.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ checkup.status|title }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Start Time:</th>
                                    <td>{{ checkup.timestamp }}</td>
                                </tr>
                                {% if checkup.scan_duration %}
                                <tr>
                                    <th>Duration:</th>
                                    <td>{{ checkup.scan_duration }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="checkup-stat" style="background-color: rgba(220, 53, 69, 0.1);">
                                    <div class="value text-danger">{{ checkup.high_vulnerabilities }}</div>
                                    <div class="label">High Risk</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="checkup-stat" style="background-color: rgba(255, 193, 7, 0.1);">
                                    <div class="value text-warning">{{ checkup.medium_vulnerabilities }}</div>
                                    <div class="label">Medium Risk</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="checkup-stat" style="background-color: rgba(40, 167, 69, 0.1);">
                                    <div class="value text-success">{{ checkup.low_vulnerabilities }}</div>
                                    <div class="label">Low Risk</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="checkup-stat" style="background-color: rgba(138, 86, 255, 0.1);">
                                    <div class="value" style="color: var(--accent-color);">{{ checkup.total_vulnerabilities }}</div>
                                    <div class="label">Total</div>
                                </div>
                            </div>
                        </div>
                        
                        {% if checkup.total_vulnerabilities > 0 %}
                        <div class="mt-3">
                            <h6><i class="fas fa-chart-pie me-2"></i>Vulnerability Distribution</h6>
                            <div class="progress" style="height: 20px; border-radius: 10px;">
                                {% if checkup.high_vulnerabilities > 0 %}
                                <div class="progress-bar bg-danger" style="width: {{ checkup.high_vulnerabilities|floatformat:0 }}%">
                                    High
                                </div>
                                {% endif %}
                                {% if checkup.medium_vulnerabilities > 0 %}
                                <div class="progress-bar bg-warning" style="width: {{ checkup.medium_vulnerabilities|floatformat:0 }}%">
                                    Medium
                                </div>
                                {% endif %}
                                {% if checkup.low_vulnerabilities > 0 %}
                                <div class="progress-bar bg-success" style="width: {{ checkup.low_vulnerabilities|floatformat:0 }}%">
                                    Low
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Vulnerabilities</h5>
                <div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-secondary filter-btn active" data-filter="all">All</button>
                        <button type="button" class="btn btn-sm btn-outline-danger filter-btn" data-filter="critical,high">High Risk</button>
                        <button type="button" class="btn btn-sm btn-outline-warning filter-btn" data-filter="medium">Medium Risk</button>
                        <button type="button" class="btn btn-sm btn-outline-success filter-btn" data-filter="low">Low Risk</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if vulnerabilities %}
                <div class="vulnerability-list">
                    {% for vuln in vulnerabilities %}
                    <div class="vuln-card card mb-3 {{ vuln.severity }}" data-severity="{{ vuln.severity }}">
                        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                            <div>
                                <span class="severity-badge {% if vuln.severity == 'critical' %}bg-danger{% elif vuln.severity == 'high' %}bg-warning text-dark{% elif vuln.severity == 'medium' %}bg-info text-dark{% else %}bg-success{% endif %}">
                                    {{ vuln.severity|title }}
                                </span>
                                <span class="status-badge {% if vuln.status == 'open' %}bg-danger{% elif vuln.status == 'in_progress' %}bg-warning text-dark{% elif vuln.status == 'resolved' %}bg-success{% else %}bg-secondary{% endif %} ms-2">
                                    {{ vuln.status|title }}
                                </span>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-link toggle-details">
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ vuln.title }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">{{ vuln.affected_component }}</h6>
                            
                            <div class="vuln-details mt-3">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h6>Description</h6>
                                        <p>{{ vuln.description }}</p>
                                    </div>
                                </div>
                                
                                {% if vuln.cve_id %}
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h6>CVE Reference</h6>
                                        <p>
                                            <a href="https://nvd.nist.gov/vuln/detail/{{ vuln.cve_id }}" target="_blank" class="cve-link">
                                                {{ vuln.cve_id }} <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </p>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h6>Remediation Steps</h6>
                                        <p>{{ vuln.remediation_steps }}</p>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-12">
                                        <h6>Update Status</h6>
                                        <form method="post" action="{% url 'scanner:update_vulnerability_status' vuln.id %}">
                                            {% csrf_token %}
                                            <div class="input-group">
                                                <select name="status" class="form-select">
                                                    <option value="open" {% if vuln.status == 'open' %}selected{% endif %}>Open</option>
                                                    <option value="in_progress" {% if vuln.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                                    <option value="resolved" {% if vuln.status == 'resolved' %}selected{% endif %}>Resolved</option>
                                                    <option value="false_positive" {% if vuln.status == 'false_positive' %}selected{% endif %}>False Positive</option>
                                                </select>
                                                <button type="submit" class="btn btn-primary">Update</button>
                                            </div>
                                            <div class="form-text text-muted">
                                                Last updated: {{ vuln.last_updated }}
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                    No vulnerabilities found in this checkup.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle vulnerability details
        const toggleButtons = document.querySelectorAll('.toggle-details');
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.vuln-card');
                card.classList.toggle('expanded');
            });
        });
        
        // Filter vulnerabilities by severity
        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Update active button
                filterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Get filter value
                const filter = this.getAttribute('data-filter');
                const filterValues = filter.split(',');
                
                // Filter cards
                const cards = document.querySelectorAll('.vuln-card');
                cards.forEach(card => {
                    const severity = card.getAttribute('data-severity');
                    if (filter === 'all' || filterValues.includes(severity)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });
    });
</script>
{% endblock %}
