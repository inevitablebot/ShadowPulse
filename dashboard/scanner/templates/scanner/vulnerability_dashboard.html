{% extends 'scanner/base.html' %}
{% load static %}

{% block page_title %}Vulnerability Management{% endblock %}

{% block extra_css %}
<style>
    .vuln-card {
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .vuln-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    .stats-value {
        font-size: 2.2rem;
        font-weight: 700;
        background: linear-gradient(45deg, #8a56ff, #53a0fd);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 5px;
    }
    .stats-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        font-weight: 500;
    }
    .progress-lg {
        height: 12px;
        border-radius: 6px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    .scan-progress {
        height: 8px;
        border-radius: 4px;
        background-color: rgba(255,255,255,0.1);
    }
    .target-card {
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
    }
    .target-card:hover {
        background-color: rgba(138, 86, 255, 0.15);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .target-card.selected {
        background-color: rgba(138, 86, 255, 0.25);
        border-left: 3px solid var(--accent-color);
        box-shadow: 0 5px 15px rgba(138, 86, 255, 0.2);
    }
    .scan-options {
        display: none;
    }
    .scan-type-option {
        cursor: pointer;
        border: 1px solid rgba(255,255,255,0.1);
        background-color: rgba(255,255,255,0.05);
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .scan-type-option:hover {
        background-color: rgba(138, 86, 255, 0.15);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .scan-type-option.selected {
        background-color: rgba(138, 86, 255, 0.25);
        border-color: var(--accent-color);
        box-shadow: 0 5px 15px rgba(138, 86, 255, 0.2);
    }
    .scan-type-option .check-icon {
        display: none;
    }
    .scan-type-option.selected .check-icon {
        display: inline-block;
    }
    .card-header {
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .badge {
        font-weight: 500;
        letter-spacing: 0.5px;
    }
    .progress-bar {
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: width 0.5s ease;
    }
    .table th {
        font-weight: 600;
        color: rgba(255,255,255,0.8);
        border-top: none;
    }
    .table td {
        vertical-align: middle;
    }
    .btn-primary {
        background: linear-gradient(45deg, #8a56ff, #53a0fd);
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Vulnerability Overview</h5>
                <div>
                    <form method="post" action="{% url 'scanner:vanish_vulnerability_data' %}" class="d-inline" onsubmit="return confirm('Are you sure you want to clear all vulnerability data? This action cannot be undone.')">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger me-2">
                            <i class="fas fa-trash-alt me-1"></i> Vanish Data
                        </button>
                    </form>
                    <a href="{% url 'scanner:vulnerabilities_list' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-list me-1"></i> View All Vulnerabilities
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="vuln-card card mb-3" style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.2) 0%, rgba(220, 53, 69, 0.1) 100%); border-radius: 12px;">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                                </div>
                                <h3 class="stats-value">{{ vuln_counts.critical|add:vuln_counts.high }}</h3>
                                <p class="stats-label mb-0">High Risk Vulnerabilities</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="vuln-card card mb-3" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 193, 7, 0.1) 100%); border-radius: 12px;">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="fas fa-exclamation-circle fa-2x text-warning"></i>
                                </div>
                                <h3 class="stats-value">{{ vuln_counts.medium }}</h3>
                                <p class="stats-label mb-0">Medium Risk Vulnerabilities</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="vuln-card card mb-3" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.2) 0%, rgba(40, 167, 69, 0.1) 100%); border-radius: 12px;">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="fas fa-info-circle fa-2x text-success"></i>
                                </div>
                                <h3 class="stats-value">{{ vuln_counts.low }}</h3>
                                <p class="stats-label mb-0">Low Risk Vulnerabilities</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="vuln-card card mb-3" style="background: linear-gradient(135deg, rgba(138, 86, 255, 0.2) 0%, rgba(138, 86, 255, 0.1) 100%); border-radius: 12px;">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="fas fa-clipboard-list fa-2x" style="color: var(--accent-color);"></i>
                                </div>
                                <h3 class="stats-value">{{ status_counts.open }}</h3>
                                <p class="stats-label mb-0">Open Issues</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6 class="mb-2">Vulnerability Severity Distribution</h6>
                        <div class="progress progress-lg mb-4" style="height: 24px; border-radius: 12px; background-color: rgba(255,255,255,0.1);">
                            {% with total=vuln_counts.critical|add:vuln_counts.high|add:vuln_counts.medium|add:vuln_counts.low %}
                                {% if total > 0 %}
                                    {% with critical_percent=vuln_counts.critical|default:0|floatformat:0 high_percent=vuln_counts.high|default:0|floatformat:0 medium_percent=vuln_counts.medium|default:0|floatformat:0 low_percent=vuln_counts.low|default:0|floatformat:0 %}
                                        {% if vuln_counts.critical > 0 %}
                                        <div class="progress-bar bg-danger" style="width: {% if critical_percent == '0' and vuln_counts.critical > 0 %}5{% else %}{{ critical_percent }}{% endif %}%; min-width: 40px;">
                                            <span class="fw-bold">Critical ({{ vuln_counts.critical }})</span>
                                        </div>
                                        {% endif %}
                                        {% if vuln_counts.high > 0 %}
                                        <div class="progress-bar bg-warning text-dark" style="width: {% if high_percent == '0' and vuln_counts.high > 0 %}5{% else %}{{ high_percent }}{% endif %}%; min-width: 40px;">
                                            <span class="fw-bold">High ({{ vuln_counts.high }})</span>
                                        </div>
                                        {% endif %}
                                        {% if vuln_counts.medium > 0 %}
                                        <div class="progress-bar bg-info text-dark" style="width: {% if medium_percent == '0' and vuln_counts.medium > 0 %}5{% else %}{{ medium_percent }}{% endif %}%; min-width: 40px;">
                                            <span class="fw-bold">Medium ({{ vuln_counts.medium }})</span>
                                        </div>
                                        {% endif %}
                                        {% if vuln_counts.low > 0 %}
                                        <div class="progress-bar bg-success" style="width: {% if low_percent == '0' and vuln_counts.low > 0 %}5{% else %}{{ low_percent }}{% endif %}%; min-width: 40px;">
                                            <span class="fw-bold">Low ({{ vuln_counts.low }})</span>
                                        </div>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <div class="progress-bar bg-secondary" style="width: 100%">
                                        <span class="fw-bold">No vulnerabilities found</span>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6 class="mb-2">Remediation Status</h6>
                        <div class="progress progress-lg" style="height: 24px; border-radius: 12px; background-color: rgba(255,255,255,0.1);">
                            {% with total=status_counts.open|add:status_counts.in_progress|add:status_counts.resolved|add:status_counts.false_positive %}
                                {% if total > 0 %}
                                    {% with open_percent=status_counts.open|default:0|floatformat:0 in_progress_percent=status_counts.in_progress|default:0|floatformat:0 resolved_percent=status_counts.resolved|default:0|floatformat:0 false_positive_percent=status_counts.false_positive|default:0|floatformat:0 %}
                                        {% if status_counts.open > 0 %}
                                        <div class="progress-bar bg-danger" style="width: {% if open_percent == '0' and status_counts.open > 0 %}5{% else %}{{ open_percent }}{% endif %}%; min-width: 40px;">
                                            <span class="fw-bold">Open ({{ status_counts.open }})</span>
                                        </div>
                                        {% endif %}
                                        {% if status_counts.in_progress > 0 %}
                                        <div class="progress-bar bg-warning text-dark" style="width: {% if in_progress_percent == '0' and status_counts.in_progress > 0 %}5{% else %}{{ in_progress_percent }}{% endif %}%; min-width: 40px;">
                                            <span class="fw-bold">In Progress ({{ status_counts.in_progress }})</span>
                                        </div>
                                        {% endif %}
                                        {% if status_counts.resolved > 0 %}
                                        <div class="progress-bar bg-success" style="width: {% if resolved_percent == '0' and status_counts.resolved > 0 %}5{% else %}{{ resolved_percent }}{% endif %}%; min-width: 40px;">
                                            <span class="fw-bold">Resolved ({{ status_counts.resolved }})</span>
                                        </div>
                                        {% endif %}
                                        {% if status_counts.false_positive > 0 %}
                                        <div class="progress-bar bg-secondary" style="width: {% if false_positive_percent == '0' and status_counts.false_positive > 0 %}5{% else %}{{ false_positive_percent }}{% endif %}%; min-width: 40px;">
                                            <span class="fw-bold">False Positive ({{ status_counts.false_positive }})</span>
                                        </div>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <div class="progress-bar bg-secondary" style="width: 100%">
                                        <span class="fw-bold">No vulnerabilities found</span>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-dark">
                <h5 class="mb-0"><i class="fas fa-search-shield me-2"></i>Start New Scan</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Select a target and scan type to begin a vulnerability assessment.</p>

                <h6 class="mb-2 text-light"><span class="badge bg-primary me-2">1</span>Select Target</h6>
                <div class="target-list mb-4" style="max-height: 300px; overflow-y: auto;">
                    {% for target in targets %}
                    <div class="target-card p-3 mb-2 rounded" data-target-id="{{ target.id }}">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-server fa-lg text-primary"></i>
                            </div>
                            <div>
                                <div class="fw-bold fs-5">{{ target.ip_address }}</div>
                                <div class="small text-muted">{{ target.hostname|default:"Unknown hostname" }}</div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>No targets available. <a href="{% url 'scanner:add_target' %}" class="alert-link">Add a target</a> first.
                    </div>
                    {% endfor %}
                </div>

                <div class="scan-options">
                    <h6 class="mb-3 text-light"><span class="badge bg-primary me-2">2</span>Select Scan Type</h6>
                    <div class="scan-type-option rounded p-3 mb-3" data-scan-type="quick">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-bolt me-2 text-warning"></i>Quick Scan</h6>
                                <p class="text-muted mb-0 small">Basic security check (5-10 minutes)</p>
                            </div>
                            <div class="check-icon">
                                <i class="fas fa-check-circle text-success fa-lg"></i>
                            </div>
                        </div>
                    </div>

                    <div class="scan-type-option selected rounded p-3 mb-3" data-scan-type="standard">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-shield-alt me-2 text-primary"></i>Standard Scan</h6>
                                <p class="text-muted mb-0 small">Comprehensive assessment (15-30 minutes)</p>
                            </div>
                            <div class="check-icon">
                                <i class="fas fa-check-circle text-success fa-lg"></i>
                            </div>
                        </div>
                    </div>

                    <div class="scan-type-option rounded p-3 mb-3" data-scan-type="deep">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-search-plus me-2 text-danger"></i>Deep Scan</h6>
                                <p class="text-muted mb-0 small">Thorough security analysis (30-60 minutes)</p>
                            </div>
                            <div class="check-icon">
                                <i class="fas fa-check-circle text-success fa-lg"></i>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <form id="scanForm" method="post" action="{% url 'scanner:start_vulnerability_scan' %}">
                            {% csrf_token %}
                            <input type="hidden" id="targetIdInput" name="target_id" value="">
                            <input type="hidden" id="scanTypeInput" name="scan_type" value="standard">
                            <button type="submit" class="btn btn-primary w-100 py-2" style="border-radius: 8px;">
                                <i class="fas fa-play me-2"></i> Start Vulnerability Scan
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Recent Vulnerability Scans</h5>
                <div id="activeScanStatus" class="d-none">
                    <span class="badge bg-warning">
                        <i class="fas fa-spinner fa-spin me-1"></i> Scan in Progress
                    </span>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="activeScanProgress" class="d-none p-3">
                    <div class="d-flex justify-content-between mb-2">
                        <div>
                            <strong id="scanStatusTarget">Target: </strong>
                        </div>
                        <div>
                            <span id="scanStatusMessage">Initializing...</span>
                        </div>
                    </div>
                    <div class="progress scan-progress mb-3">
                        <div id="scanProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                    </div>
                    <div class="text-end">
                        <form method="post" action="{% url 'scanner:stop_vulnerability_scan' %}">
                            {% csrf_token %}
                            <input type="hidden" id="stopScanTargetId" name="target_id" value="">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-stop me-1"></i> Stop Scan
                            </button>
                        </form>
                    </div>
                </div>

                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Target</th>
                            <th>Scan Type</th>
                            <th>Status</th>
                            <th>Vulnerabilities</th>
                            <th>Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for checkup in recent_checkups %}
                        <tr>
                            <td>{{ checkup.target.ip_address }}</td>
                            <td>{{ checkup.scan_type|title }}</td>
                            <td>
                                <span class="badge {% if checkup.status == 'completed' %}bg-success{% elif checkup.status == 'failed' %}bg-danger{% elif checkup.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ checkup.status|title }}
                                </span>
                            </td>
                            <td>
                                {% if checkup.status == 'completed' %}
                                <div class="d-flex align-items-center">
                                    {% if checkup.high_vulnerabilities > 0 %}
                                    <span class="badge bg-danger me-1">{{ checkup.high_vulnerabilities }}</span>
                                    {% endif %}
                                    {% if checkup.medium_vulnerabilities > 0 %}
                                    <span class="badge bg-warning text-dark me-1">{{ checkup.medium_vulnerabilities }}</span>
                                    {% endif %}
                                    {% if checkup.low_vulnerabilities > 0 %}
                                    <span class="badge bg-success me-1">{{ checkup.low_vulnerabilities }}</span>
                                    {% endif %}
                                    {% if checkup.total_vulnerabilities == 0 %}
                                    <span class="badge bg-secondary">0</span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ checkup.timestamp|date:"M d, H:i" }}</td>
                            <td>
                                {% if checkup.status == 'completed' %}
                                <a href="{% url 'scanner:vulnerability_checkup_detail' checkup.id %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% else %}
                                <button class="btn btn-sm btn-outline-secondary" disabled>
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">No vulnerability scans found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables to track active scan
    let activeScanTargetId = null;
    let scanStatusInterval = null;

    // Function to update scan status
    function updateScanStatus() {
        if (!activeScanTargetId) return;

        fetch(`{% url 'scanner:vulnerability_scan_status' 0 %}`.replace('0', activeScanTargetId))
            .then(response => response.json())
            .then(data => {
                if (data.running) {
                    // Update progress bar
                    document.getElementById('scanProgressBar').style.width = `${data.progress}%`;
                    document.getElementById('scanStatusMessage').textContent = data.status_message;

                    // Show active scan section
                    document.getElementById('activeScanStatus').classList.remove('d-none');
                    document.getElementById('activeScanProgress').classList.remove('d-none');

                    // Set target ID for stop button
                    document.getElementById('stopScanTargetId').value = activeScanTargetId;
                } else {
                    // Scan completed or not running
                    clearInterval(scanStatusInterval);
                    activeScanTargetId = null;

                    // Hide active scan section
                    document.getElementById('activeScanStatus').classList.add('d-none');
                    document.getElementById('activeScanProgress').classList.add('d-none');

                    // Reload page to show updated results
                    if (data.checkup_id) {
                        window.location.reload();
                    }
                }
            })
            .catch(error => console.error('Error fetching scan status:', error));
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Target selection
        const targetCards = document.querySelectorAll('.target-card');
        targetCards.forEach(card => {
            card.addEventListener('click', function() {
                // Remove selection from all cards
                targetCards.forEach(c => c.classList.remove('selected'));

                // Add selection to clicked card
                this.classList.add('selected');

                // Show scan options
                document.querySelector('.scan-options').style.display = 'block';

                // Set target ID in form
                const targetId = this.getAttribute('data-target-id');
                document.getElementById('targetIdInput').value = targetId;

                // Update scan target display
                const targetName = this.querySelector('.fw-bold').textContent;
                document.getElementById('scanStatusTarget').textContent = `Target: ${targetName}`;
            });
        });

        // Scan type selection
        const scanTypeOptions = document.querySelectorAll('.scan-type-option');
        scanTypeOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Remove selection from all options
                scanTypeOptions.forEach(o => o.classList.remove('selected'));

                // Add selection to clicked option
                this.classList.add('selected');

                // Set scan type in form
                const scanType = this.getAttribute('data-scan-type');
                document.getElementById('scanTypeInput').value = scanType;
            });
        });

        // Check for active scans
        {% for target in targets %}
        fetch(`{% url 'scanner:vulnerability_scan_status' target.id %}`)
            .then(response => response.json())
            .then(data => {
                if (data.running) {
                    activeScanTargetId = '{{ target.id }}';
                    document.getElementById('scanStatusTarget').textContent = `Target: {{ target.ip_address }}`;
                    updateScanStatus();

                    // Start interval to update status
                    scanStatusInterval = setInterval(updateScanStatus, 3000);
                }
            })
            .catch(error => console.error('Error checking scan status:', error));
        {% endfor %}
    });
</script>
{% endblock %}
