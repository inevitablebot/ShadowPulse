{% extends 'scanner/base.html' %}

{% block extra_css %}
<style>
    /* Custom styles for OS Info page */
    .section-list, .command-list {
        max-height: 600px;
        overflow-y: auto;
    }

    .list-group-item-info {
        background-color: #343a40;
        color: white;
        font-weight: bold;
    }

    .section-item:hover, .command-item:hover {
        background-color: #f8f9fa;
    }

    .section-item.active, .command-item.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    pre {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 10px;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .html-report iframe {
        width: 100%;
        height: 600px;
        border: none;
    }

    /* Styles for formatted output */
    .key-value-container {
        margin-bottom: 1rem;
    }

    .key-value-container dt {
        font-weight: bold;
        color: #495057;
    }

    .key-value-container dd {
        margin-bottom: 0.5rem;
    }

    .section-title {
        color: #0d6efd;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }

    .table-responsive {
        margin-bottom: 1rem;
    }

    .table-responsive table {
        margin-bottom: 0;
    }

    .list-container {
        margin-bottom: 1rem;
    }

    .list-title {
        color: #0d6efd;
        margin-bottom: 1rem;
    }

    .list-styled li {
        margin-bottom: 0.5rem;
    }

    .generic-output pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 500px;
        overflow-y: auto;
    }

    .result-content {
        background-color: white;
        padding: 1rem;
        border-radius: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-desktop me-2"></i>OS Information Dashboard</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-primary mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Instructions:</strong> Select a target system from the list, then choose either an individual section (recommended) or a full command to run. Results will be displayed in the right panel.
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0"><i class="fas fa-server me-2"></i>Target Systems</h5>
                            </div>
                            <div class="card-body">
                                {% if targets %}
                                    <div class="list-group">
                                        {% for target in targets %}
                                            <a href="#" class="list-group-item list-group-item-action target-item"
                                               data-target-id="{{ target.id }}" data-target-ip="{{ target.ip_address }}">
                                                <div class="d-flex w-100 justify-content-between">
                                                    <h6 class="mb-1">{{ target.ip_address }}</h6>
                                                    <small>{{ target.last_scan|default:"Never scanned"|date:"Y-m-d H:i" }}</small>
                                                </div>
                                                <small>{{ target.hostname|default:"Unknown hostname" }}</small>
                                            </a>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">
                                        No target systems added yet.
                                        <a href="{% url 'scanner:add_target' %}" class="alert-link">Add a target</a> to get started.
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>OS Information Commands</h5>
                            </div>
                            <div class="card-body p-0">
                                <!-- Command type selector tabs -->
                                <ul class="nav nav-tabs" id="commandTypeTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="sections-tab" data-bs-toggle="tab"
                                                data-bs-target="#sections-content" type="button" role="tab"
                                                aria-controls="sections-content" aria-selected="true">
                                            <i class="fas fa-puzzle-piece me-1"></i>Individual Sections
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="full-commands-tab" data-bs-toggle="tab"
                                                data-bs-target="#full-commands-content" type="button" role="tab"
                                                aria-controls="full-commands-content" aria-selected="false">
                                            <i class="fas fa-file-alt me-1"></i>Full Reports
                                        </button>
                                    </li>
                                </ul>

                                <!-- Tab content -->
                                <div class="tab-content p-3" id="commandTypeContent">
                                    <!-- Individual Sections Tab -->
                                    <div class="tab-pane fade show active" id="sections-content" role="tabpanel" aria-labelledby="sections-tab">
                                        <div class="alert alert-success mb-3">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <strong>Recommended:</strong> Individual sections provide faster, more reliable results.
                                        </div>

                                        <div class="list-group section-list" style="display: none;">
                                            <!-- Display sections by category -->
                                            {% for category, category_sections in sections_by_category.items %}
                                                <div class="list-group-item list-group-item-info">{{ category }}</div>
                                                {% for section in category_sections %}
                                                    <button class="list-group-item list-group-item-action section-item"
                                                            data-section-id="{{ section.id }}" data-section-name="{{ section.name }}">
                                                        <i class="fas fa-file-alt me-2"></i>{{ section.name }}
                                                    </button>
                                                {% endfor %}
                                            {% endfor %}
                                        </div>
                                        <div class="alert alert-info select-target-message">
                                            Please select a target system first.
                                        </div>
                                    </div>

                                    <!-- Full Commands Tab -->
                                    <div class="tab-pane fade" id="full-commands-content" role="tabpanel" aria-labelledby="full-commands-tab">
                                        <div class="alert alert-warning mb-3">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Note:</strong> Full reports may experience timeout issues with large systems.
                                        </div>

                                        <div class="list-group command-list" style="display: none;">
                                            <!-- Basic Commands -->
                                            <div class="list-group-item list-group-item-info">Basic Commands</div>

                                            <button class="list-group-item list-group-item-action command-item"
                                                    data-command-code="1" data-command-name="Basic OS Info">
                                                <i class="fas fa-info-circle me-2"></i>Basic OS Info
                                            </button>

                                            <button class="list-group-item list-group-item-action command-item"
                                                    data-command-code="5" data-command-name="Full OS Report">
                                                <i class="fas fa-file-alt me-2"></i>Full OS Report
                                            </button>

                                            <button class="list-group-item list-group-item-action command-item"
                                                    data-command-code="4" data-command-name="System Diagnostic">
                                                <i class="fas fa-stethoscope me-2"></i>System Diagnostic
                                            </button>
                                        </div>
                                        <div class="alert alert-info select-target-message">
                                            Please select a target system first.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0 result-title"><i class="fas fa-chart-bar me-2"></i>Results</h5>
                            </div>
                            <div class="card-body result-container" id="result-container">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>Select a target and command to view results.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        let selectedTargetId = null;
        let selectedTargetIp = null;

        // Handle target selection
        $('.target-item').click(function(e) {
            e.preventDefault();

            // Update selected target
            selectedTargetId = $(this).data('target-id');
            selectedTargetIp = $(this).data('target-ip');

            // Update UI
            $('.target-item').removeClass('active');
            $(this).addClass('active');

            // Show commands and sections
            $('.command-list').show();
            $('.section-list').show();
            $('.select-target-message').hide();

            // Update result title
            $('.result-title').text(`Results for ${selectedTargetIp}`);

            // Clear results
            $('#result-container').html('<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Select a command to run.</div>');
        });

        // Handle command selection
        $('.command-item').click(function() {
            if (selectedTargetId) {
                const commandCode = $(this).data('command-code');
                const commandName = $(this).data('command-name');

                // Update UI
                $('.command-item').removeClass('active');
                $('.section-item').removeClass('active');
                $(this).addClass('active');

                // Show loading indicator
                const resultContainer = document.getElementById('result-container');
                if (resultContainer) {
                    resultContainer.innerHTML = `
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                            <p class="mt-3 text-primary fw-bold">Loading ${commandName}, please wait...</p>
                        </div>`;
                }

                // Send command
                sendCommand(selectedTargetId, commandCode, commandName);
            }
        });

        // Handle section selection
        $('.section-item').click(function() {
            if (selectedTargetId) {
                const sectionId = $(this).data('section-id');
                const sectionName = $(this).data('section-name');

                // Update UI
                $('.section-item').removeClass('active');
                $('.command-item').removeClass('active');
                $(this).addClass('active');

                // Show loading indicator
                const resultContainer = document.getElementById('result-container');
                if (resultContainer) {
                    resultContainer.innerHTML = `
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                            <p class="mt-3 text-primary fw-bold">Loading ${sectionName}, please wait...</p>
                        </div>`;
                }

                // Send request for the section
                fetch(`/scanner/target/${selectedTargetId}/section/${sectionId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Check if the result is HTML content
                            if (data.result_data.trim().startsWith('<!DOCTYPE html>') ||
                                data.result_data.trim().startsWith('<html>')) {
                                // Create an iframe to display it properly
                                const iframeContainer = document.createElement('div');
                                iframeContainer.className = 'html-report';

                                // Create a blob URL for the HTML content
                                const blob = new Blob([data.result_data], {type: 'text/html'});
                                const url = URL.createObjectURL(blob);

                                // Create an iframe and set its source to the blob URL
                                const iframe = document.createElement('iframe');
                                iframe.src = url;

                                // Add the iframe to the container
                                iframeContainer.appendChild(iframe);
                                resultContainer.innerHTML = '';
                                resultContainer.appendChild(iframeContainer);
                            } else {
                                // Check if the result is already HTML
                                if (data.result_data.trim().startsWith('<div') ||
                                    data.result_data.trim().startsWith('<table') ||
                                    data.result_data.trim().startsWith('<pre')) {
                                    // It's already formatted HTML, wrap it in a container
                                    resultContainer.innerHTML = `
                                        <div class="bg-light p-3 border rounded">
                                            <h5 class="mb-3 text-primary"><i class="fas fa-file-alt me-2"></i>${sectionName}</h5>
                                            <div class="result-content" style="max-height: 500px; overflow-y: auto;">
                                                ${data.result_data}
                                            </div>
                                        </div>`;
                                } else {
                                    // It's plain text, wrap in pre tags with styling
                                    resultContainer.innerHTML = `
                                        <div class="bg-light p-3 border rounded">
                                            <h5 class="mb-3 text-primary"><i class="fas fa-file-alt me-2"></i>${sectionName}</h5>
                                            <pre class="mb-0" style="max-height: 500px; overflow-y: auto;">${data.result_data}</pre>
                                        </div>`;
                                }
                            }
                        } else {
                            resultContainer.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Error:</strong> ${data.message}
                                </div>`;
                        }
                    })
                    .catch(error => {
                        resultContainer.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Network Error:</strong> ${error.message}
                            </div>`;
                    });
            }
        });

        // Function to send command to target
        function sendCommand(targetId, commandCode, commandName) {
            const resultContainer = document.getElementById('result-container');

            // Send the command
            fetch(`/scanner/target/${targetId}/command/${commandCode}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Check if the result is already HTML
                        if (data.result_data.trim().startsWith('<div') ||
                            data.result_data.trim().startsWith('<table') ||
                            data.result_data.trim().startsWith('<pre')) {
                            // It's already formatted HTML, wrap it in a container
                            resultContainer.innerHTML = `
                                <div class="bg-light p-3 border rounded">
                                    <h5 class="mb-3 text-primary"><i class="fas fa-file-alt me-2"></i>${commandName}</h5>
                                    <div class="result-content" style="max-height: 500px; overflow-y: auto;">
                                        ${data.result_data}
                                    </div>
                                </div>`;
                        } else {
                            // It's plain text, wrap in pre tags with styling
                            resultContainer.innerHTML = `
                                <div class="bg-light p-3 border rounded">
                                    <h5 class="mb-3 text-primary"><i class="fas fa-file-alt me-2"></i>${commandName}</h5>
                                    <pre class="mb-0" style="max-height: 500px; overflow-y: auto;">${data.result_data}</pre>
                                </div>`;
                        }
                    } else {
                        resultContainer.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Error:</strong> ${data.message}
                            </div>`;
                    }
                })
                .catch(error => {
                    resultContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Network Error:</strong> ${error.message}
                        </div>`;
                });
        }
    });
</script>
{% endblock %}
